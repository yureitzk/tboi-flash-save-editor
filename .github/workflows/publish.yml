name: Publish to npm

on:
 push:
  branches:
   - main
 workflow_dispatch:

jobs:
 publish:
  runs-on: ubuntu-latest
  permissions:
   contents: read
   id-token: write
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: '20'
      registry-url: 'https://registry.npmjs.org'

   - name: Install dependencies
     run: npm ci

   - name: Run tests
     run: npm test

   - name: Build project
     run: npm run build

   - name: Check types
     run: npm run types:check

   - uses: JS-DevTools/npm-publish@v3
     with:
      token: ${{ secrets.NPM_TOKEN }}
